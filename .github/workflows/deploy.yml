name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:   # allows manual trigger from the Actions tab

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Generate config.js from GitHub Secrets ─────────────────────────
      # The real config.js is git-ignored; this step creates it at deploy
      # time using values stored as encrypted repository secrets.
      # Secrets are passed as env vars and .trim()-ed by Node to strip any
      # accidental trailing newlines that would break the JS string literal.
      - name: Generate config.js
        env:
          FIREBASE_API_KEY:            ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN:        ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_DATABASE_URL:       ${{ secrets.FIREBASE_DATABASE_URL }}
          FIREBASE_PROJECT_ID:         ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET:     ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID:             ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID:     ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          node -e "
            const fs = require('fs');
            const cfg = {
              apiKey:            process.env.FIREBASE_API_KEY.trim(),
              authDomain:        process.env.FIREBASE_AUTH_DOMAIN.trim(),
              databaseURL:       process.env.FIREBASE_DATABASE_URL.trim(),
              projectId:         process.env.FIREBASE_PROJECT_ID.trim(),
              storageBucket:     process.env.FIREBASE_STORAGE_BUCKET.trim(),
              messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID.trim(),
              appId:             process.env.FIREBASE_APP_ID.trim(),
              measurementId:     process.env.FIREBASE_MEASUREMENT_ID.trim(),
            };
            fs.writeFileSync('config.js', 'window.firebaseConfig = ' + JSON.stringify(cfg, null, 2) + ';\n');
          "

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: .   # upload entire repo root (config.js now exists here)

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
